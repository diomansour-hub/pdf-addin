<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer Add-in</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Office.js: The Microsoft Office JavaScript API library -->
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" type="text/javascript"></script>
    
    <!-- PDF.js: Library to render PDF documents in the browser -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    
    <style>
        /* ... (styles blijven ongewijzigd) ... */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .draw-mode-active {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
            background-color: #1d4ed8;
        }

        .page-container {
            position: relative;
            margin: 0.5rem auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .annotation-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="app" class="p-4 flex flex-col h-screen">
        <!-- ... (HTML blijft ongewijzigd) ... -->
        <header class="mb-4">
            <h1 class="text-xl font-bold text-gray-800">PDF Beheerder</h1>
            <p class="text-sm text-gray-600">Bed een PDF in, bekijk of exporteer de opgeslagen PDF.</p>
        </header>

        <div class="controls bg-white p-3 rounded-lg shadow-sm border border-gray-200 mb-4">
            <div class="flex items-center space-x-2">
                <label for="pdf-file-input" class="cursor-pointer bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors text-sm font-medium">
                    Kies PDF
                </label>
                <input type="file" id="pdf-file-input" accept=".pdf" class="hidden">
                <button id="save-pdf-button" disabled class="bg-gray-300 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                    Sla PDF op
                </button>
                <button id="export-pdf-button" disabled class="bg-gray-300 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                    Exporteer PDF
                </button>
                <button id="draw-mode-button" class="bg-blue-500 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors hover:bg-blue-600">
                    Teken Modus
                </button>
            </div>
            <p id="selected-file-name" class="text-xs text-gray-500 mt-2 truncate">Geen bestand geselecteerd.</p>
        </div>

        <main class="flex-grow bg-white rounded-lg shadow-sm border border-gray-200 overflow-y-auto p-2">
            <div id="status-message" class="h-full flex flex-col items-center justify-center text-gray-500">
                <div id="loader" class="loader hidden mb-2"></div>
                <span id="status-text">Selecteer een PDF of laad een bestaande.</span>
            </div>
            <div id="pdf-viewer" class="space-y-2">
            </div>
        </main>
    </div>

    <script type="text/javascript">
        // ... (worker setup ongewijzigd) ...
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        Office.onReady((info) => {
            if (info.host === Office.HostType.Excel) {
                // ... (UI elementen en state ongewijzigd) ...
                const fileInput = document.getElementById('pdf-file-input');
                const saveButton = document.getElementById('save-pdf-button');
                const exportButton = document.getElementById('export-pdf-button');
                const drawModeButton = document.getElementById('draw-mode-button');
                const selectedFileNameLabel = document.getElementById('selected-file-name');
                const pdfViewer = document.getElementById('pdf-viewer');
                const statusMessage = document.getElementById('status-message');
                const statusText = document.getElementById('status-text');
                const loader = document.getElementById('loader');

                let selectedFile = null;
                let isDrawingMode = false;
                let isDrawing = false;
                let annotations = {};
                let startCoords = { x: 0, y: 0 };

                // ... (Event listeners en hoofd-functies blijven hetzelfde) ...
                fileInput.addEventListener('change', handleFileSelect);
                saveButton.addEventListener('click', savePdfToSettings);
                exportButton.addEventListener('click', exportPdfFromSettings);
                drawModeButton.addEventListener('click', toggleDrawMode);

                function handleFileSelect(event) {
                    if (event.target.files.length > 0) {
                        selectedFile = event.target.files[0];
                        selectedFileNameLabel.textContent = `Geselecteerd: ${selectedFile.name}`;
                        saveButton.disabled = false;
                        saveButton.classList.replace('bg-gray-300', 'bg-green-600');
                    }
                }

                function toggleDrawMode() {
                    isDrawingMode = !isDrawingMode;
                    drawModeButton.classList.toggle('draw-mode-active', isDrawingMode);
                    pdfViewer.style.cursor = isDrawingMode ? 'crosshair' : 'default';
                }

                function savePdfToSettings() {
                    if (!selectedFile) return;
                    showLoader('PDF wordt opgeslagen...');
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const base64String = arrayBufferToBase64(event.target.result);
                        Office.context.document.settings.set('embeddedPdfData', base64String);
                        Office.context.document.settings.set('embeddedPdfName', selectedFile.name);
                        Office.context.document.settings.set('embeddedAnnotations', JSON.stringify({}));
                        
                        Office.context.document.settings.saveAsync((asyncResult) => {
                            if (asyncResult.status === Office.AsyncResultStatus.Succeeded) {
                                updateStatus(`'${selectedFile.name}' is succesvol opgeslagen.`, 'success');
                                loadAndRenderPdfFromSettings();
                            } else {
                                updateStatus('Fout bij opslaan: ' + asyncResult.error.message, 'error');
                            }
                        });
                    };
                    reader.readAsArrayBuffer(selectedFile);
                }

                function loadAndRenderPdfFromSettings() {
                    showLoader('Opgeslagen PDF laden...');
                    const pdfName = Office.context.document.settings.get('embeddedPdfName');
                    const base64Data = Office.context.document.settings.get('embeddedPdfData');
                    const annotationsJson = Office.context.document.settings.get('embeddedAnnotations');
                    annotations = annotationsJson ? JSON.parse(annotationsJson) : {};

                    if (base64Data && pdfName) {
                        selectedFileNameLabel.textContent = `Huidig bestand: ${pdfName}`;
                        exportButton.disabled = false;
                        exportButton.classList.replace('bg-gray-300', 'bg-orange-500');
                        
                        const pdfData = base64ToUint8Array(base64Data);
                        renderPdf(pdfData);
                    } else {
                        updateStatus('Geen ingebedde PDF gevonden.', 'info');
                        exportButton.disabled = true;
                        exportButton.classList.replace('bg-orange-500', 'bg-gray-300');
                    }
                }
                
                // --- Teken-functies blijven hetzelfde ---
                async function renderPdf(data) {
                    pdfViewer.innerHTML = '';
                    try {
                        const pdf = await pdfjsLib.getDocument({ data }).promise;
                        updateStatus(`Bezig met weergeven van ${pdf.numPages} pagina('s)...`, 'loading');

                        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                            const page = await pdf.getPage(pageNum);
                            const viewport = page.getViewport({ scale: 1.5 });

                            const pageContainer = document.createElement('div');
                            pageContainer.className = 'page-container';
                            pageContainer.style.width = `${viewport.width}px`;
                            pageContainer.style.height = `${viewport.height}px`;

                            const pdfCanvas = document.createElement('canvas');
                            pdfCanvas.width = viewport.width;
                            pdfCanvas.height = viewport.height;

                            const annotationCanvas = document.createElement('canvas');
                            annotationCanvas.className = 'annotation-canvas';
                            annotationCanvas.width = viewport.width;
                            annotationCanvas.height = viewport.height;
                            
                            pageContainer.appendChild(pdfCanvas);
                            pageContainer.appendChild(annotationCanvas);
                            pdfViewer.appendChild(pageContainer);

                            await page.render({ canvasContext: pdfCanvas.getContext('2d'), viewport: viewport }).promise;
                            drawAnnotations(pageNum, annotationCanvas);

                            annotationCanvas.addEventListener('mousedown', (e) => handleMouseDown(e, pageNum, annotationCanvas));
                            annotationCanvas.addEventListener('mousemove', (e) => handleMouseMove(e, pageNum, annotationCanvas));
                            annotationCanvas.addEventListener('mouseup', (e) => handleMouseUp(e, pageNum));
                            annotationCanvas.addEventListener('mouseout', (e) => handleMouseUp(e, pageNum));
                        }
                        statusMessage.classList.add('hidden');
                    } catch (error) {
                        updateStatus('Fout bij het weergeven van de PDF: ' + error.message, 'error');
                    }
                }

                function handleMouseDown(e, pageNum, canvas) {
                    if (!isDrawingMode) return;
                    isDrawing = true;
                    const rect = canvas.getBoundingClientRect();
                    startCoords.x = e.clientX - rect.left;
                    startCoords.y = e.clientY - rect.top;
                }

                function handleMouseMove(e, pageNum, canvas) {
                    if (!isDrawing || !isDrawingMode) return;
                    const rect = canvas.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const mouseY = e.clientY - rect.top;
                    const width = mouseX - startCoords.x;
                    const height = mouseY - startCoords.y;
                    drawAnnotations(pageNum, canvas, { x: startCoords.x, y: startCoords.y, w: width, h: height });
                }

                function handleMouseUp(e, pageNum) {
                    if (!isDrawing || !isDrawingMode) return;
                    isDrawing = false;
                    const canvas = document.querySelectorAll('.annotation-canvas')[pageNum - 1];
                    const rect = canvas.getBoundingClientRect();
                    const endX = e.clientX - rect.left;
                    const endY = e.clientY - rect.top;
                    if (!annotations[pageNum]) {
                        annotations[pageNum] = [];
                    }
                    annotations[pageNum].push({
                        x: startCoords.x,
                        y: startCoords.y,
                        w: endX - startCoords.x,
                        h: endY - startCoords.y
                    });
                    saveAnnotations();
                }

                function drawAnnotations(pageNum, canvas, currentRect = null) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.strokeStyle = 'red';
                    ctx.lineWidth = 2;
                    if (annotations[pageNum]) {
                        annotations[pageNum].forEach(rect => {
                            ctx.strokeRect(rect.x, rect.y, rect.w, rect.h);
                        });
                    }
                    if (currentRect) {
                        ctx.strokeRect(currentRect.x, currentRect.y, currentRect.w, currentRect.h);
                    }
                }

                function saveAnnotations() {
                    Office.context.document.settings.set('embeddedAnnotations', JSON.stringify(annotations));
                    Office.context.document.settings.saveAsync(result => {
                        if (result.status === Office.AsyncResultStatus.Failed) {
                            console.error('Fout bij opslaan annotaties: ' + result.error.message);
                        }
                    });
                }
                
                // --- GECORRIGEERDE HELPER FUNCTIONS ---
                
                function exportPdfFromSettings() {
                    const pdfName = Office.context.document.settings.get('embeddedPdfName');
                    const base64Data = Office.context.document.settings.get('embeddedPdfData');

                    if (!base64Data || !pdfName) {
                        updateStatus('Geen PDF gevonden om te exporteren.', 'error');
                        return;
                    }

                    try {
                        const pdfData = base64ToUint8Array(base64Data);
                        const blob = new Blob([pdfData], { type: 'application/pdf' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = pdfName;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(link.href);
                    } catch (error) {
                        updateStatus('Fout tijdens exporteren: ' + error.message, 'error');
                    }
                }
                
                function arrayBufferToBase64(buffer) {
                    let binary = '';
                    const bytes = new Uint8Array(buffer);
                    const len = bytes.byteLength;
                    for (let i = 0; i < len; i++) {
                        binary += String.fromCharCode(bytes[i]);
                    }
                    return window.btoa(binary);
                }

                function base64ToUint8Array(base64) {
                    const binary_string = window.atob(base64);
                    const len = binary_string.length;
                    const bytes = new Uint8Array(len);
                    for (let i = 0; i < len; i++) {
                        bytes[i] = binary_string.charCodeAt(i);
                    }
                    return bytes;
                }

                function showLoader(text) {
                    statusMessage.classList.remove('hidden');
                    loader.classList.remove('hidden');
                    statusText.textContent = text;
                    pdfViewer.innerHTML = '';
                }
                
                function updateStatus(text, type) {
                    statusMessage.classList.remove('hidden');
                    loader.classList.add('hidden');
                    statusText.textContent = text;
                    
                    statusText.classList.remove('text-red-500', 'text-green-500', 'text-gray-500');
                    if (type === 'error') statusText.classList.add('text-red-500');
                    else if (type === 'success') statusText.classList.add('text-green-500');
                    else statusText.classList.add('text-gray-500');
                }
                
                // --- INITIALISATIE ---
                loadAndRenderPdfFromSettings();
            }
        });
    </script>
</body>
</html>

